<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <canvas id="canvas"></canvas>
</body>
<script type="module">
    import {initShaders} from "./utils/utils.js"
    import { Matrix4, Vector3, Quaternion, Object3D, OrthographicCamera } from 'https://unpkg.com/three/build/three.module.js';
    import Poly from "./utils/Poly.js"
    const VSHADER_SOURCE = `
        attribute vec4 a_Position;
        uniform mat4 pvMatrix;
        void main() {
            gl_Position = pvMatrix * a_Position; // 设置坐标位置
            gl_PointSize = 10.0; // 设置尺寸
        }
    `
    const FSHADER_SOURCE = `
        precision mediump float;
        uniform vec4 u_Color;
        void main(){
            gl_FragColor = u_Color; // 设置颜色
        }
    `
    canvas.width= window.innerWidth;
    canvas.height= window.innerHeight;
    // 获取WebGL绘图上下文
    const gl = canvas.getContext('webgl');
    initShaders(gl, VSHADER_SOURCE, FSHADER_SOURCE)
    // 指定清空canvas的颜色
    gl.clearColor(0, 0, 0, 1);

    const halfH = 2
    const ratio = canvas.width/canvas.height
    const halfW = halfH*ratio
    const [left,rignt,top,bottom,near,far] = [
        -halfW, halfW, halfH, -halfH, 0, 4
    ]
    const eye = new Vector3(1, 1, 3)
    const target = new Vector3(0, 0, 0)
    const up = new Vector3(0, 1, 0)
   
    const positionMatrix = new Matrix4().setPosition(eye)
    const rotationMatrix = new Matrix4().lookAt(eye,target,up)
    const viewMatrix = new Matrix4().multiplyMatrices(
        positionMatrix,rotationMatrix
    ).invert()
    const camera = new OrthographicCamera(left,rignt,top,bottom,near,far)
    const projectionMatrix = camera.projectionMatrix
    const pvMatrix = new Matrix4()
    pvMatrix.multiplyMatrices(
        projectionMatrix,
        viewMatrix
    )

    const triangle1 = crtTriangle(
        [ 1.0 ,0.0 ,0.0 ,1.0 ],
        [
            0, 0.3, -0.2,
            -0.3, -0.3, -0.2,
            0.3, -0.3, -0.2
        ]
    )
    const triangle2 = crtTriangle(
        [ 1.0 ,1.0 ,0.0 ,1.0 ],
        [
            0, 0.3, 0.2,
            -0.3, -0.3, 0.2,
            0.3, -0.3, 0.2
        ]
    )
    
    render()
    function crtTriangle(color,source) {
        return new Poly({
            gl,
            source,
            type: 'TRIANGLES',
            attributes:{
                a_Position:{
                    size: 3,
                    index: 0
                }
            },
            uniforms:{
                u_Color:{
                    type: 'uniform4fv',
                    value: color
                },
                pvMatrix:{
                    type: 'uniformMatrix4fv',
                    value: pvMatrix.elements
                }
            }
        })
    }
    function render() {
         // 清空canvas
        gl.clear(gl.COLOR_BUFFER_BIT);
        triangle1.init()
        triangle1.draw()
        triangle2.init()
        triangle2.draw()
    }
    
</script>
</html>